<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grelha Ativa - Monitoriza√ß√£o da Participa√ß√£o</title>
    <style>
        :root {
            /* Paleta de Cores Primitiva */
            --color-white: #fff;
            --color-black: #000;
            --color-cream-50: #fcfcf9;
            --color-cream-100: #fffffD;
            --color-gray-200: #f5f5f5;
            --color-gray-300: #a7a9a9;
            --color-gray-400: #777c7c;
            --color-slate-500: #626c71;
            --color-brown-600: #5e5240;
            --color-charcoal-700: #1f2121;
            --color-charcoal-800: #262828;
            --color-slate-900: #13343b;
            --color-teal-300: #32b8c6;
            --color-teal-400: #2da6b2;
            --color-teal-500: #21808d;
            --color-teal-600: #1d7480;
            --color-teal-700: #1a6873;
            --color-red-400: #ff5459;
            --color-red-500: #c0152f;
            --color-orange-400: #e68161;
            --color-orange-500: #a84b2f;

            /* Cores RGB para controlo de opacidade */
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-red-500-rgb: 192, 21, 47;

            /* Tokens de Cor Sem√¢nticos (Modo Claro) */
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --color-info: var(--color-slate-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);

            /* Tipografia */
            --font-family-base: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-bold: 600;

            /* Espa√ßamento */
            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-24: 24px;

            /* Raio da Borda */
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-lg: 12px;
            --radius-full: 9999px;

            /* Sombras */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);

            /* Anima√ß√£o */
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

            /* Layout */
            --container-xl: 1280px;
        }

        /* Estilos Base */
        html {
            font-family: var(--font-family-base);
            color: var(--color-text);
            background-color: var(--color-background);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
        }

        *, *::before, *::after {
            box-sizing: inherit;
        }

        h3 { font-size: var(--font-size-xl); margin: 0; }
        h4 { font-size: var(--font-size-lg); margin: 0; }

        /* Bot√µes */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-8) var(--space-16);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            border: 1px solid transparent;
            text-decoration: none;
        }
        .btn:focus-visible {
            outline: 2px solid var(--color-focus-ring);
            outline-offset: 2px;
        }
        .btn--primary { background-color: var(--color-primary); color: var(--color-btn-primary-text); }
        .btn--primary:hover { background-color: var(--color-primary-hover); }
        .btn--secondary { background-color: var(--color-secondary); color: var(--color-text); }
        .btn--secondary:hover { background-color: var(--color-secondary-hover); }
        .btn--outline { background-color: transparent; border-color: var(--color-border); color: var(--color-text); }
        .btn--outline:hover { background-color: var(--color-secondary); }
        .btn--danger { background-color: var(--color-error); color: var(--color-white); }
        .btn--danger:hover { background-color: rgba(var(--color-red-500-rgb), 0.85); }
        .btn--sm { padding: var(--space-4) var(--space-12); font-size: var(--font-size-sm); border-radius: var(--radius-sm); }
        .btn--full-width { width: 100%; }

        /* Formul√°rios */
        .form-control {
            display: block;
            width: 100%;
            padding: var(--space-8) var(--space-12);
            color: var(--color-text);
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
        }
        .form-label { display: block; margin-bottom: var(--space-8); font-weight: var(--font-weight-medium); font-size: var(--font-size-sm); }
        .form-group { margin-bottom: var(--space-16); }

        /* Componente Card */
        .card {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-card-border);
            box-shadow: var(--shadow-sm);
            padding: var(--space-16);
        }

        /* Indicadores de Estado */
        .status { display: inline-flex; padding: var(--space-4) var(--space-12); border-radius: var(--radius-full); font-weight: var(--font-weight-medium); font-size: var(--font-size-sm); }
        .status--success { background-color: rgba(var(--color-teal-500-rgb), 0.15); color: var(--color-success); }
        .status--info { background-color: rgba(var(--color-slate-900-rgb), 0.1); color: var(--color-info); }
        .status--warning { background-color: rgba(var(--color-orange-500), 0.15); color: var(--color-warning); }

        /* Layout do Container */
        .container { width: 100%; margin: 0 auto; padding: 0 var(--space-16); max-width: var(--container-xl); }

        /* Estilos Espec√≠ficos da Aplica√ß√£o */
        .app-container { min-height: 100vh; display: flex; flex-direction: column; }

        /* Cabe√ßalho */
        .header { background-color: var(--color-surface); border-bottom: 1px solid var(--color-border); padding: var(--space-16) 0; box-shadow: var(--shadow-sm); }
        .header .container { display: flex; align-items: center; justify-content: space-between; }
        .header__title { font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-primary); margin: 0; }
        .class-selector { font-size: var(--font-size-lg); font-weight: var(--font-weight-medium); color: var(--color-text-secondary); cursor: pointer; border-bottom: 2px dotted var(--color-text-secondary); padding-bottom: 2px; transition: color var(--duration-normal), border-color var(--duration-normal); }
        .class-selector:hover { color: var(--color-primary); border-color: var(--color-primary); }

        /* Conte√∫do Principal */
        .main-content { flex: 1; padding: var(--space-24) 0; }
        .layout-container { display: grid; grid-template-columns: 280px 1fr 280px; gap: var(--space-24); }

        /* Pain√©is */
        .students-panel, .control-panel { height: fit-content; max-height: calc(100vh - 160px); display: flex; flex-direction: column; }
        .panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-16); padding-bottom: var(--space-16); border-bottom: 1px solid var(--color-card-border); }
        .students-list { min-height: 200px; margin-bottom: var(--space-16); overflow-y: auto; }
        .panel-actions { margin-top: auto; display: flex; gap: var(--space-8); }

        .student-item { display: flex; align-items: center; justify-content: space-between; padding: var(--space-12); margin-bottom: var(--space-8); background-color: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-base); cursor: grab; user-select: none; transition: background-color var(--duration-normal); }
        .student-item:hover { background-color: var(--color-secondary); }
        .student-name { font-weight: var(--font-weight-medium); }
        .student-number { font-size: var(--font-size-sm); color: var(--color-text-secondary); }
        .student-actions { display: flex; align-items: center; gap: var(--space-4); }
        .student-action-btn { background: none; border: none; font-size: var(--font-size-lg); cursor: pointer; padding: var(--space-4); border-radius: var(--radius-sm); transition: color var(--duration-normal), background-color var(--duration-normal); }
        .student-action-btn.edit { color: var(--color-info); }
        .student-action-btn.edit:hover { color: var(--color-primary); background-color: var(--color-secondary); }
        .student-action-btn.remove { color: var(--color-error); }
        .student-action-btn.remove:hover { background-color: rgba(var(--color-red-500-rgb), 0.1); }

        /* Sec√ß√£o da Sala de Aula */
        .classroom-section { display: flex; flex-direction: column; }
        .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-16); }
        .classroom-grid { display: grid; grid-template-columns: repeat(6, 1fr); grid-template-rows: repeat(6, 1fr); gap: var(--space-8); flex: 1; background-color: var(--color-surface); padding: var(--space-16); border: 1px solid var(--color-card-border); border-radius: var(--radius-lg); }

        .grid-cell { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--space-8); border-radius: var(--radius-base); transition: all var(--duration-normal) var(--ease-standard); position: relative; }
        .grid-cell.empty { border: 2px dashed var(--color-border); background-color: rgba(var(--color-slate-900-rgb), 0.02); }
        .grid-cell.occupied { border: 1px solid var(--color-border); background-color: var(--color-surface); cursor: pointer; }
        .grid-cell.occupied:hover { border-color: var(--color-primary); transform: translateY(-2px); box-shadow: var(--shadow-sm); }
        .grid-cell.drag-over { border-color: var(--color-primary); background-color: var(--color-secondary); border-style: solid; }
        .grid-cell.participated { background-color: rgba(var(--color-teal-500-rgb), 0.2); border-color: var(--color-success); }
        .cell-student-name { font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); text-align: center; }
        .cell-student-number { font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: 2px; }
        .interaction-count { position: absolute; top: var(--space-4); right: var(--space-4); background-color: var(--color-primary); color: var(--color-btn-primary-text); border-radius: var(--radius-full); width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: var(--font-size-xs); font-weight: var(--font-weight-bold); }

        .grid-cell.highlight { animation: highlight-animation 3s ease-out; }
        @keyframes highlight-animation {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(var(--color-teal-500-rgb), 0.7); }
            40% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(var(--color-teal-500-rgb), 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(var(--color-teal-500-rgb), 0); }
        }

        /* Painel de Controlo */
        .control-actions { display: flex; flex-direction: column; gap: var(--space-12); margin-bottom: var(--space-24); }
        .statistics { padding-top: var(--space-16); border-top: 1px solid var(--color-card-border); }
        .stats-grid { display: flex; flex-direction: column; gap: var(--space-12); }
        .stat-item { display: flex; justify-content: space-between; align-items: center; padding: var(--space-12); background-color: var(--color-background); border-radius: var(--radius-base); }
        .stat-label { font-size: var(--font-size-sm); color: var(--color-text-secondary); }
        .stat-value { font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-primary); }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal__overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        .modal__content { position: relative; background-color: var(--color-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); width: 90%; max-width: 500px; max-height: 80vh; display: flex; flex-direction: column; z-index: 1001; }
        .modal__content--large { max-width: 800px; }
        .modal__header { display: flex; align-items: center; justify-content: space-between; padding: var(--space-16) var(--space-24); border-bottom: 1px solid var(--color-card-border); }
        .modal__close { background: none; border: none; font-size: var(--font-size-3xl); color: var(--color-text-secondary); cursor: pointer; line-height: 1; }
        .modal__body { padding: var(--space-24); overflow-y: auto; }
        .modal__footer { padding: var(--space-12) var(--space-24); border-top: 1px solid var(--color-card-border); display: flex; justify-content: flex-end; gap: var(--space-12); }
        .confirm-modal__actions { display: flex; justify-content: flex-end; gap: var(--space-12); margin-top: var(--space-24); }

        /* Menu de Intera√ß√£o */
        .interaction-menu { position: fixed; background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); z-index: 1000; min-width: 250px; display: none; }
        .interaction-menu.active { display: block; }
        .interaction-menu__header { display: flex; align-items: center; justify-content: space-between; padding: var(--space-12) var(--space-16); border-bottom: 1px solid var(--color-card-border); }
        .interaction-menu__close { background: none; border: none; font-size: var(--font-size-xl); color: var(--color-text-secondary); cursor: pointer; }
        .interaction-menu__body { padding: var(--space-8); }
        .interaction-btn { display: flex; align-items: center; gap: var(--space-12); width: 100%; padding: var(--space-12); background: none; border: none; border-radius: var(--radius-base); cursor: pointer; font-size: var(--font-size-base); text-align: left; }
        .interaction-btn:hover { background-color: var(--color-secondary); }
        .interaction-icon { font-size: var(--font-size-lg); }

        /* Modal de Relat√≥rio */
        .report-section { margin-bottom: var(--space-24); }
        .participation-list { display: flex; flex-direction: column; gap: var(--space-8); }
        .participation-item { display: flex; align-items: center; justify-content: space-between; padding: var(--space-12); background-color: var(--color-background); border-radius: var(--radius-base); border: 1px solid var(--color-border); }
        .report-details { border: 1px solid var(--color-border); border-radius: var(--radius-base); margin-bottom: var(--space-8); }
        .report-details[open] .report-summary { border-bottom: 1px solid var(--color-border); }
        .report-summary { padding: var(--space-12); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: var(--font-weight-medium); list-style: none; }
        .report-summary::-webkit-details-marker { display: none; }
        .report-summary:hover { background-color: var(--color-secondary); }
        .report-student-list { padding: var(--space-8) var(--space-12) var(--space-12) var(--space-24); margin: 0; list-style-type: none; }
        .report-student-list li { padding: var(--space-4) 0; color: var(--color-text-secondary); }
        .report-summary-label { display: flex; align-items: center; gap: var(--space-8); }

        /* Feedback Visual de Arrastar e Soltar */
        .dragging { opacity: 0.5; }
        .empty-state { text-align: center; color: var(--color-text-secondary); padding: var(--space-24); }

        /* Notifica√ß√µes Toast */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; }
        .toast { color: white; padding: 12px 16px; border-radius: var(--radius-base); box-shadow: var(--shadow-lg); max-width: 300px; animation: slideIn 0.3s ease-out; font-size: var(--font-size-sm); }
        .toast--success { background-color: var(--color-success); }
        .toast--error { background-color: var(--color-error); }
        .toast--info { background-color: var(--color-info); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

        /* Responsividade */
        @media (max-width: 1024px) {
            .layout-container { grid-template-columns: 1fr; grid-template-rows: auto; }
            .students-panel, .control-panel { max-height: none; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Cabe√ßalho -->
        <header class="header">
            <div class="container">
                <h1 class="header__title">Grelha Ativa</h1>
                <div id="class-selector-container">
                    <span id="active-class-name" class="class-selector"></span>
                </div>
            </div>
        </header>

        <!-- Conte√∫do Principal -->
        <main class="main-content">
            <div class="container">
                <div class="layout-container">
                    <!-- Painel da Lista de Alunos -->
                    <aside class="students-panel card">
                        <div class="panel-header">
                            <h3>Lista de Alunos</h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn--secondary btn--sm" id="import-csv-btn">Importar CSV</button>
                                <button class="btn btn--primary btn--sm" id="add-student-btn-modal">Adicionar</button>
                            </div>
                        </div>
                        <div class="students-list" id="students-list"></div>
                        <div class="panel-actions">
                            <button class="btn btn--secondary btn--sm btn--full-width" id="save-layout-btn">Guardar Layout</button>
                        </div>
                    </aside>

                    <!-- Grelha da Sala de Aula -->
                    <div class="classroom-section">
                        <div class="section-header">
                            <h3>Layout da Sala</h3>
                            <div id="class-status"></div>
                        </div>
                        <div class="classroom-grid" id="classroom-grid"></div>
                    </div>

                    <!-- Painel de Controlo -->
                    <aside class="control-panel card">
                        <div class="panel-header">
                            <h3>Painel de Controlo</h3>
                        </div>
                        <div class="control-actions">
                            <button class="btn btn--primary btn--full-width" id="toggle-class-btn">Iniciar Aula</button>
                            <button class="btn btn--secondary btn--full-width" id="random-student-btn">Selecionar Aluno Aleat√≥rio</button>
                            <button class="btn btn--outline btn--full-width" id="clear-data-btn">Limpar Dados da Aula</button>
                            <button class="btn btn--secondary btn--full-width" id="show-report-btn" style="display: none;">Ver Relat√≥rio</button>
                        </div>
                        <div class="statistics" id="statistics" style="display: none;">
                            <h4>Estat√≠sticas da Aula</h4>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <span class="stat-label">Total de Intera√ß√µes</span>
                                    <span class="stat-value" id="total-interactions">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Alunos Participantes</span>
                                    <span class="stat-value" id="participating-students">0</span>
                                </div>
                            </div>
                        </div>
                    </aside>
                </div>
            </div>
        </main>
    </div>

    <!-- Input de ficheiro oculto para importa√ß√£o de CSV -->
    <input type="file" id="csv-file-input" style="display: none;" accept=".csv">

    <!-- Container para as notifica√ß√µes Toast -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Modais -->
    <div class="modal" id="add-student-modal">
        <div class="modal__overlay"></div>
        <div class="modal__content">
            <div class="modal__header">
                <h3>Adicionar Aluno</h3>
                <button class="modal__close">&times;</button>
            </div>
            <div class="modal__body">
                <form id="add-student-form">
                    <div class="form-group">
                        <label class="form-label" for="add-student-name">Nome do Aluno</label>
                        <input type="text" class="form-control" id="add-student-name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="add-student-number">N√∫mero do Aluno</label>
                        <input type="text" class="form-control" id="add-student-number" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn--primary btn--full-width">Adicionar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="edit-student-modal">
        <div class="modal__overlay"></div>
        <div class="modal__content">
            <div class="modal__header">
                <h3>Editar Aluno</h3>
                <button class="modal__close">&times;</button>
            </div>
            <div class="modal__body">
                <form id="edit-student-form">
                    <input type="hidden" id="edit-student-id">
                    <div class="form-group">
                        <label class="form-label" for="edit-student-name">Nome do Aluno</label>
                        <input type="text" class="form-control" id="edit-student-name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-student-number">N√∫mero do Aluno</label>
                        <input type="text" class="form-control" id="edit-student-number" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn--primary btn--full-width">Guardar Altera√ß√µes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="interaction-menu" id="interaction-menu">
        <div class="interaction-menu__header">
            <h4 id="interaction-student-name"></h4>
            <button class="interaction-menu__close">&times;</button>
        </div>
        <div class="interaction-menu__body"></div>
    </div>

    <div class="modal" id="report-modal">
        <div class="modal__overlay"></div>
        <div class="modal__content modal__content--large">
            <div class="modal__header">
                <h3>Relat√≥rio da Aula</h3>
                <button class="modal__close">&times;</button>
            </div>
            <div class="modal__body">
                <div class="report-section">
                    <h4>Alunos Menos Participativos</h4>
                    <div id="low-participation-list" class="participation-list"></div>
                </div>
                <div class="report-section">
                    <h4>Detalhe das Intera√ß√µes</h4>
                    <div id="interaction-details-container"></div>
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn--primary" id="export-report-btn">Exportar para CSV</button>
            </div>
        </div>
    </div>

    <div class="modal" id="confirm-modal">
        <div class="modal__overlay"></div>
        <div class="modal__content">
            <div class="modal__header">
                <h3 id="confirm-modal-title">Confirmar A√ß√£o</h3>
                <button class="modal__close">&times;</button>
            </div>
            <div class="modal__body">
                <p id="confirm-modal-text"></p>
                <div class="confirm-modal__actions">
                    <button class="btn btn--outline" id="confirm-cancel-btn">Cancelar</button>
                    <button class="btn btn--primary" id="confirm-ok-btn">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="manage-classes-modal">
        <div class="modal__overlay"></div>
        <div class="modal__content">
            <div class="modal__header">
                <h3>Gerir Turmas</h3>
                <button class="modal__close">&times;</button>
            </div>
            <div class="modal__body">
                <div class="form-group">
                    <label for="class-select-dropdown" class="form-label">Turma Ativa</label>
                    <select id="class-select-dropdown" class="form-control"></select>
                </div>
                <hr style="margin: var(--space-24) 0;">
                <form id="create-class-form" class="form-group">
                    <label for="new-class-name" class="form-label">Criar Nova Turma</label>
                    <input type="text" id="new-class-name" class="form-control" placeholder="Nome da nova turma" required>
                    <button type="submit" class="btn btn--primary btn--full-width" style="margin-top: var(--space-8);">Criar</button>
                </form>
                <hr style="margin: var(--space-24) 0;">
                <form id="rename-class-form" class="form-group">
                    <label for="rename-class-name" class="form-label">Renomear Turma Ativa</label>
                    <input type="text" id="rename-class-name" class="form-control" placeholder="Novo nome para a turma" required>
                    <button type="submit" class="btn btn--secondary btn--full-width" style="margin-top: var(--space-8);">Renomear</button>
                </form>
                <hr style="margin: var(--space-24) 0;">
                <div class="form-group">
                    <label class="form-label">Apagar Turma Ativa</label>
                    <button class="btn btn--danger btn--full-width" id="delete-class-btn">Apagar Turma</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTES E ESTADO DA APLICA√á√ÉO ---
            const GRID_SIZE = 36;
            const APP_STATE_KEY = 'grelhaAtivaMultiClassState';

            const INTERACTION_TYPES = {
                "question": { label: "Fez uma pergunta", icon: "‚ùì" },
                "correct_answer": { label: "Deu resposta correcta", icon: "‚úÖ" },
                "difficulty": { label: "Mostrou dificuldade", icon: "ü§î" },
                "helped_colleague": { label: "Ajudou um colega", icon: "ü§ù" }
            };

            const initialClassState = () => ({
                students: [],
                classroomLayout: {},
                interactions: {},
                isClassActive: false,
                nextStudentId: 1
            });

            let appState = {
                classes: {},
                activeClassId: null,
                nextClassId: 1
            };

            // --- ELEMENTOS DO DOM ---
            const DOMElements = {
                activeClassName: document.getElementById('active-class-name'),
                studentsList: document.getElementById('students-list'),
                classroomGrid: document.getElementById('classroom-grid'),
                toggleClassBtn: document.getElementById('toggle-class-btn'),
                classStatus: document.getElementById('class-status'),
                statistics: document.getElementById('statistics'),
                showReportBtn: document.getElementById('show-report-btn'),
                totalInteractions: document.getElementById('total-interactions'),
                participatingStudents: document.getElementById('participating-students'),
                addStudentForm: document.getElementById('add-student-form'),
                editStudentForm: document.getElementById('edit-student-form'),
                interactionMenu: document.getElementById('interaction-menu'),
                interactionMenuBody: document.querySelector('#interaction-menu .interaction-menu__body'),
                confirmModal: document.getElementById('confirm-modal'),
                confirmModalText: document.getElementById('confirm-modal-text'),
                confirmOkBtn: document.getElementById('confirm-ok-btn'),
                manageClassesModal: document.getElementById('manage-classes-modal'),
                classSelectDropdown: document.getElementById('class-select-dropdown'),
                createClassForm: document.getElementById('create-class-form'),
                renameClassForm: document.getElementById('rename-class-form'),
                deleteClassBtn: document.getElementById('delete-class-btn'),
                csvFileInput: document.getElementById('csv-file-input'),
                importCsvBtn: document.getElementById('import-csv-btn'),
                randomStudentBtn: document.getElementById('random-student-btn'),
                toastContainer: document.getElementById('toast-container'),
            };

            // --- FUN√á√ïES DE L√ìGICA DE NEG√ìCIO ---

            const getActiveClass = () => appState.classes[appState.activeClassId] || null;

            const saveState = () => {
                try {
                    localStorage.setItem(APP_STATE_KEY, JSON.stringify(appState));
                } catch (e) {
                    console.error("Falha ao guardar o estado no localStorage", e);
                    showToast("N√£o foi poss√≠vel guardar o estado.", "error");
                }
            };

            const loadState = () => {
                try {
                    const savedState = localStorage.getItem(APP_STATE_KEY);
                    if (savedState) {
                        appState = JSON.parse(savedState);
                    }
                } catch (e) {
                    console.error("Falha ao carregar o estado do localStorage", e);
                    appState = { classes: {}, activeClassId: null, nextClassId: 1 }; // Reset state on error
                }
            };

            const createNewClass = (name, shouldSave = true) => {
                const newClassId = `class_${appState.nextClassId++}`;
                appState.classes[newClassId] = {
                    id: newClassId,
                    name: name,
                    ...initialClassState()
                };
                appState.activeClassId = newClassId;
                if (shouldSave) {
                    saveState();
                    showToast(`Turma "${name}" criada com sucesso.`, 'success');
                }
            };

            const addStudent = (name, number) => {
                const activeClass = getActiveClass();
                if (!activeClass) return;

                if (activeClass.students.some(s => s.number === number)) {
                    showToast('J√° existe um aluno com este n√∫mero nesta turma.', 'error');
                    return false;
                }
                const newStudent = { id: activeClass.nextStudentId++, name, number };
                activeClass.students.push(newStudent);
                saveState();
                showToast(`Aluno ${name} adicionado com sucesso.`, 'success');
                return true;
            };

            const updateStudent = (id, name, number) => {
                const activeClass = getActiveClass();
                if (!activeClass) return;

                if (activeClass.students.some(s => s.number === number && s.id !== id)) {
                    showToast('J√° existe outro aluno com este n√∫mero nesta turma.', 'error');
                    return false;
                }

                const studentToUpdate = activeClass.students.find(s => s.id === id);
                if (studentToUpdate) {
                    studentToUpdate.name = name;
                    studentToUpdate.number = number;
                }

                Object.values(activeClass.classroomLayout).forEach(studentInCell => {
                    if (studentInCell?.id === id) {
                        studentInCell.name = name;
                        studentInCell.number = number;
                    }
                });

                saveState();
                showToast(`Aluno ${name} atualizado com sucesso.`, 'success');
                return true;
            };

            const removeStudent = (studentId) => {
                const activeClass = getActiveClass();
                if (!activeClass) return;

                const student = activeClass.students.find(s => s.id === studentId);
                if (!student) return;

                activeClass.students = activeClass.students.filter(s => s.id !== studentId);
                Object.keys(activeClass.classroomLayout).forEach(key => {
                    if (activeClass.classroomLayout[key]?.id === studentId) {
                        delete activeClass.classroomLayout[key];
                    }
                });
                delete activeClass.interactions[studentId];

                saveState();
                showToast(`Aluno ${student.name} removido com sucesso.`, 'success');
                renderAll();
            };

            const processCSV = (csvText) => {
                const activeClass = getActiveClass();
                if (!activeClass) return;

                const lines = csvText.split(/\r\n|\n/);
                let importedCount = 0;
                let skippedCount = 0;

                lines.slice(1).forEach(line => {
                    line = line.trim();
                    if (line === '') return;

                    const parts = line.split(/[,;]/);
                    if (parts.length < 2) {
                        skippedCount++;
                        return;
                    }

                    const name = parts[0].trim();
                    const number = parts[1].trim();

                    if (!name || !number || activeClass.students.some(s => s.number === number)) {
                        skippedCount++;
                        return;
                    }

                    const newStudent = { id: activeClass.nextStudentId++, name, number };
                    activeClass.students.push(newStudent);
                    importedCount++;
                });

                if (importedCount > 0) {
                    saveState();
                    renderAll();
                    showToast(`${importedCount} aluno(s) importado(s) com sucesso.`, 'success');
                }
                if (skippedCount > 0) {
                    showToast(`${skippedCount} aluno(s) ignorado(s) (duplicados ou formato inv√°lido).`, 'info');
                }
                if (importedCount === 0 && skippedCount === 0) {
                    showToast('N√£o foram encontrados alunos para importar no ficheiro.', 'warning');
                }
            };

            // --- FUN√á√ïES DE RENDERIZA√á√ÉO E UI ---

            const renderAll = () => {
                const activeClass = getActiveClass();
                if (!activeClass) {
                    // Lida com o estado em que nenhuma turma est√° ativa (p.e., ap√≥s apagar a √∫ltima)
                    document.querySelector('.layout-container').style.display = 'none';
                    updateHeader();
                    return;
                }
                document.querySelector('.layout-container').style.display = 'grid';
                renderStudentsList();
                renderClassroomGrid();
                updateStatistics();
                updateClassStatusUI();
                updateHeader();
                setupDragAndDrop();
            };

            const updateHeader = () => {
                DOMElements.activeClassName.textContent = getActiveClass()?.name || "Nenhuma turma selecionada";
            };

            const renderStudentsList = () => {
                const activeClass = getActiveClass();
                const studentsInGridIds = new Set(Object.values(activeClass.classroomLayout).filter(Boolean).map(s => s.id));
                const availableStudents = activeClass.students.filter(student => !studentsInGridIds.has(student.id));

                if (activeClass.students.length === 0) {
                    DOMElements.studentsList.innerHTML = `<div class="empty-state"><p>Nenhum aluno. Adicione alunos ou importe um CSV.</p></div>`;
                } else if (availableStudents.length === 0) {
                    DOMElements.studentsList.innerHTML = `<div class="empty-state"><p>Todos os alunos est√£o na grelha.</p></div>`;
                } else {
                    DOMElements.studentsList.innerHTML = availableStudents.map(student => `
                        <div class="student-item" draggable="true" data-student-id="${student.id}">
                            <div>
                                <div class="student-name">${student.name}</div>
                                <div class="student-number">N¬∫ ${student.number}</div>
                            </div>
                            <div class="student-actions">
                                <button class="student-action-btn edit" data-student-id="${student.id}" title="Editar aluno">‚úèÔ∏è</button>
                                <button class="student-action-btn remove" data-student-id="${student.id}" title="Remover aluno">&times;</button>
                            </div>
                        </div>
                    `).join('');
                }
            };

            const renderClassroomGrid = () => {
                const activeClass = getActiveClass();
                const gridHtml = Array.from({ length: GRID_SIZE }, (_, i) => {
                    const student = activeClass.classroomLayout[i];
                    const interactionCount = student ? Object.values(activeClass.interactions[student.id] || {}).reduce((a, b) => a + b, 0) : 0;
                    
                    if (student) {
                        return `
                            <div class="grid-cell occupied ${interactionCount > 0 ? 'participated' : ''}" data-cell-index="${i}" data-student-id="${student.id}">
                                <div class="cell-student-name">${student.name}</div>
                                <div class="cell-student-number">N¬∫ ${student.number}</div>
                                ${interactionCount > 0 ? `<div class="interaction-count">${interactionCount}</div>` : ''}
                            </div>`;
                    } else {
                        return `<div class="grid-cell empty" data-cell-index="${i}"></div>`;
                    }
                }).join('');
                DOMElements.classroomGrid.innerHTML = gridHtml;
            };

            const updateStatistics = () => {
                const activeClass = getActiveClass();
                const totalInteractions = Object.values(activeClass.interactions)
                    .flatMap(Object.values)
                    .reduce((sum, count) => sum + count, 0);
                
                const participatingStudentsCount = Object.keys(activeClass.interactions).filter(id =>
                    Object.values(activeClass.interactions[id]).reduce((a, b) => a + b, 0) > 0
                ).length;

                DOMElements.totalInteractions.textContent = totalInteractions;
                DOMElements.participatingStudents.textContent = participatingStudentsCount;
            };

            const updateClassStatusUI = () => {
                const activeClass = getActiveClass();
                const isActive = activeClass.isClassActive;

                DOMElements.toggleClassBtn.textContent = isActive ? 'Terminar Aula' : 'Iniciar Aula';
                DOMElements.toggleClassBtn.classList.toggle('btn--primary', !isActive);
                DOMElements.toggleClassBtn.classList.toggle('btn--outline', isActive);

                DOMElements.classStatus.innerHTML = isActive
                    ? '<span class="status status--success">Aula Ativa</span>'
                    : '<span class="status status--info">Configura√ß√£o</span>';
                
                DOMElements.statistics.style.display = isActive ? 'block' : 'none';
                DOMElements.showReportBtn.style.display = isActive ? 'block' : 'none';
            };

            const showToast = (message, type = 'info') => {
                const toast = document.createElement('div');
                toast.className = `toast toast--${type}`;
                toast.textContent = message;
                DOMElements.toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease-in forwards';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            };

            const showModal = (modalId) => {
                closeAllModals();
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('active');
                    if (modalId === 'report-modal') generateReport();
                }
            };

            const closeAllModals = () => {
                document.querySelectorAll('.modal.active').forEach(modal => modal.classList.remove('active'));
            };
            
            const showConfirmation = (message, onConfirm) => {
                DOMElements.confirmModalText.textContent = message;
                // Clone and replace the button to remove old event listeners
                const newOkBtn = DOMElements.confirmOkBtn.cloneNode(true);
                DOMElements.confirmOkBtn.parentNode.replaceChild(newOkBtn, DOMElements.confirmOkBtn);
                DOMElements.confirmOkBtn = newOkBtn;

                DOMElements.confirmOkBtn.addEventListener('click', () => {
                    closeAllModals();
                    onConfirm();
                }, { once: true }); // Ensure the listener only fires once
                showModal('confirm-modal');
            };

            // --- GESTORES DE EVENTOS (HANDLERS) ---
            
            function handleStudentAction(e) {
                const button = e.target.closest('.student-action-btn');
                if (!button) return;
                
                const studentId = parseInt(button.dataset.studentId);
                const activeClass = getActiveClass();
                const student = activeClass.students.find(s => s.id === studentId);

                if (button.classList.contains('remove')) {
                    if (student) {
                        showConfirmation(`Tem a certeza que deseja remover o aluno ${student.name}?`, () => removeStudent(studentId));
                    }
                } else if (button.classList.contains('edit')) {
                    if (student) {
                        document.getElementById('edit-student-id').value = student.id;
                        document.getElementById('edit-student-name').value = student.name;
                        document.getElementById('edit-student-number').value = student.number;
                        showModal('edit-student-modal');
                    }
                }
            }

            function handleAddStudentSubmit(e) {
                e.preventDefault();
                const name = document.getElementById('add-student-name').value.trim();
                const number = document.getElementById('add-student-number').value.trim();
                if (name && number && addStudent(name, number)) {
                    e.target.reset();
                    closeAllModals();
                    renderAll();
                }
            }

            function handleEditStudentSubmit(e) {
                e.preventDefault();
                const id = parseInt(document.getElementById('edit-student-id').value);
                const name = document.getElementById('edit-student-name').value.trim();
                const number = document.getElementById('edit-student-number').value.trim();
                if (name && number && updateStudent(id, name, number)) {
                    closeAllModals();
                    renderAll();
                }
            }
            
            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => processCSV(e.target.result);
                reader.readAsText(file);
                event.target.value = ''; // Reset input
            }

            function handleDrop(e) {
                e.preventDefault();
                const activeClass = getActiveClass();
                if (activeClass.isClassActive) return;
                e.currentTarget.classList.remove('drag-over');

                const studentId = parseInt(e.dataTransfer.getData('text/plain'));
                const targetCellIndex = parseInt(e.currentTarget.dataset.cellIndex);
                const originCellIndex = e.dataTransfer.getData('origin-cell');
                const student = activeClass.students.find(s => s.id === studentId);
                
                if (!student) return;

                const studentInTargetCell = activeClass.classroomLayout[targetCellIndex];

                if (originCellIndex) delete activeClass.classroomLayout[originCellIndex];
                
                activeClass.classroomLayout[targetCellIndex] = student;

                if (studentInTargetCell && originCellIndex) {
                    activeClass.classroomLayout[originCellIndex] = studentInTargetCell;
                }

                saveState();
                renderAll();
            }

            function handleCellClick(e) {
                const cell = e.target.closest('.grid-cell.occupied');
                if (!cell) return;

                const activeClass = getActiveClass();
                if (!activeClass.isClassActive) return;
                
                const studentId = parseInt(cell.dataset.studentId);
                const student = activeClass.students.find(s => s.id === studentId);
                if (student) showInteractionMenu(cell, student);
            }

            function handleCellDoubleClick(e) {
                const cell = e.target.closest('.grid-cell.occupied');
                if (!cell) return;

                const activeClass = getActiveClass();
                if (activeClass.isClassActive) return;

                const cellIndex = parseInt(cell.dataset.cellIndex);
                const student = activeClass.classroomLayout[cellIndex];
                if (student) {
                    delete activeClass.classroomLayout[cellIndex];
                    showToast(`${student.name} removido da grelha.`, 'info');
                    saveState();
                    renderAll();
                }
            }
            
            // --- INICIALIZA√á√ÉO ---
            function initApp() {
                loadState();
                if (Object.keys(appState.classes).length === 0) {
                    createNewClass("Minha Primeira Turma", false); // Don't save yet
                    saveState(); // Save after creation
                }
                if (!appState.activeClassId || !appState.classes[appState.activeClassId]) {
                    appState.activeClassId = Object.keys(appState.classes)[0] || null;
                }
                
                setupEventListeners();
                renderAll();
                populateInteractionMenu();
            }

            function setupEventListeners() {
                DOMElements.activeClassName.addEventListener('click', () => {
                    populateClassManagementModal();
                    showModal('manage-classes-modal');
                });
                
                DOMElements.addStudentForm.addEventListener('submit', handleAddStudentSubmit);
                DOMElements.editStudentForm.addEventListener('submit', handleEditStudentSubmit);
                DOMElements.studentsList.addEventListener('click', handleStudentAction);
                DOMElements.classroomGrid.addEventListener('click', handleCellClick);
                DOMElements.classroomGrid.addEventListener('dblclick', handleCellDoubleClick);
                
                DOMElements.importCsvBtn.addEventListener('click', () => DOMElements.csvFileInput.click());
                DOMElements.csvFileInput.addEventListener('change', handleFileUpload);

                DOMElements.toggleClassBtn.addEventListener('click', toggleClass);
                DOMElements.randomStudentBtn.addEventListener('click', handleRandomStudentSelection);
                document.getElementById('clear-data-btn').addEventListener('click', () => {
                    showConfirmation('Tem a certeza que deseja limpar os dados de intera√ß√£o desta turma?', clearClassData);
                });
                DOMElements.showReportBtn.addEventListener('click', () => showModal('report-modal'));
                document.getElementById('save-layout-btn').addEventListener('click', () => {
                    saveState();
                    showToast('Layout guardado com sucesso!', 'success');
                });
                document.getElementById('export-report-btn').addEventListener('click', exportReportToCSV);

                document.querySelectorAll('.modal__close, .modal__overlay').forEach(el => el.addEventListener('click', closeAllModals));
                document.getElementById('confirm-cancel-btn').addEventListener('click', closeAllModals);

                document.querySelector('#interaction-menu .interaction-menu__close').addEventListener('click', closeInteractionMenu);
                DOMElements.interactionMenuBody.addEventListener('click', handleInteraction);

                // Class Management Listeners
                DOMElements.createClassForm.addEventListener('submit', handleCreateClass);
                DOMElements.classSelectDropdown.addEventListener('change', handleSelectClass);
                DOMElements.renameClassForm.addEventListener('submit', handleRenameClass);
                DOMElements.deleteClassBtn.addEventListener('click', handleDeleteClass);
                document.getElementById('add-student-btn-modal').addEventListener('click', () => showModal('add-student-modal'));

                document.addEventListener('keydown', e => {
                    if (e.key === 'Escape') {
                        closeAllModals();
                        closeInteractionMenu();
                    }
                });
            }
            
            initApp(); // Iniciar a aplica√ß√£o

            // O resto das fun√ß√µes (handlers, etc.) s√£o definidas abaixo
            // para manter a clareza.
            
            function populateInteractionMenu() {
                DOMElements.interactionMenuBody.innerHTML = Object.entries(INTERACTION_TYPES).map(([type, {label, icon}]) => `
                    <button class="interaction-btn" data-type="${type}">
                        <span class="interaction-icon">${icon}</span>
                        <span>${label}</span>
                    </button>
                `).join('');
            }

            function setupDragAndDrop() {
                const isClassActive = getActiveClass()?.isClassActive;

                document.querySelectorAll('.student-item').forEach(item => {
                    item.setAttribute('draggable', 'true');
                    item.addEventListener('dragstart', e => {
                        if (isClassActive) { e.preventDefault(); return; }
                        e.dataTransfer.setData('text/plain', e.target.dataset.studentId);
                        e.target.classList.add('dragging');
                    });
                    item.addEventListener('dragend', e => e.target.classList.remove('dragging'));
                });

                DOMElements.classroomGrid.querySelectorAll('.grid-cell.occupied').forEach(cell => {
                    cell.setAttribute('draggable', !isClassActive);
                    cell.addEventListener('dragstart', e => {
                        if (isClassActive) { e.preventDefault(); return; }
                        e.stopPropagation();
                        e.dataTransfer.setData('text/plain', e.currentTarget.dataset.studentId);
                        e.dataTransfer.setData('origin-cell', e.currentTarget.dataset.cellIndex);
                        setTimeout(() => e.target.style.opacity = '0.5', 0);
                    });
                    cell.addEventListener('dragend', e => e.target.style.opacity = '1');
                });

                DOMElements.classroomGrid.querySelectorAll('.grid-cell').forEach(cell => {
                    cell.addEventListener('dragover', e => {
                        if (isClassActive) return;
                        e.preventDefault();
                        e.currentTarget.classList.add('drag-over');
                    });
                    cell.addEventListener('dragleave', e => e.currentTarget.classList.remove('drag-over'));
                    cell.addEventListener('drop', handleDrop);
                });
            }
            
            function toggleClass() {
                const activeClass = getActiveClass();
                activeClass.isClassActive = !activeClass.isClassActive;
                if (activeClass.isClassActive) {
                    showToast('Aula iniciada! Clique nos alunos para registar intera√ß√µes.', 'success');
                } else {
                    showToast('Aula terminada.', 'info');
                    setTimeout(() => showModal('report-modal'), 1000);
                }
                saveState();
                renderAll();
            }

            function clearClassData() {
                const activeClass = getActiveClass();
                activeClass.interactions = {};
                if (activeClass.isClassActive) {
                    toggleClass(); // Termina a aula e re-renderiza
                } else {
                    saveState();
                    renderAll();
                }
                showToast('Dados da aula limpos com sucesso.', 'success');
            }
            
            function handleInteraction(e) {
                const button = e.target.closest('.interaction-btn');
                if (!button) return;

                const activeClass = getActiveClass();
                const interactionType = button.dataset.type;
                const studentId = parseInt(DOMElements.interactionMenu.dataset.studentId);
                
                if (!activeClass.interactions[studentId]) {
                    activeClass.interactions[studentId] = {};
                }
                activeClass.interactions[studentId][interactionType] = (activeClass.interactions[studentId][interactionType] || 0) + 1;
                
                closeInteractionMenu();
                const student = activeClass.students.find(s => s.id === studentId);
                showToast(`${INTERACTION_TYPES[interactionType].label}: ${student.name}`, 'success');
                saveState();
                renderAll();
            }

            function handleRandomStudentSelection() {
                const activeClass = getActiveClass();
                if (!activeClass.isClassActive) {
                    showToast("Inicie a aula para selecionar um aluno.", "info");
                    return;
                }

                const studentsInGrid = Object.entries(activeClass.classroomLayout)
                    .filter(([, student]) => student)
                    .map(([cellIndex, student]) => ({ ...student, cellIndex }));

                if (studentsInGrid.length === 0) {
                    showToast("N√£o h√° alunos na grelha.", "warning");
                    return;
                }

                const nonParticipants = studentsInGrid.filter(student => {
                    const studentInteractions = activeClass.interactions[student.id];
                    return !studentInteractions || Object.values(studentInteractions).reduce((a, b) => a + b, 0) === 0;
                });

                const pool = nonParticipants.length > 0 ? nonParticipants : studentsInGrid;
                const selectedStudent = pool[Math.floor(Math.random() * pool.length)];

                const cell = DOMElements.classroomGrid.querySelector(`[data-cell-index="${selectedStudent.cellIndex}"]`);
                if (cell) {
                    cell.classList.remove('highlight'); // Reset animation
                    void cell.offsetWidth; // Trigger reflow
                    cell.classList.add('highlight');
                }
                showToast(`Aluno selecionado: ${selectedStudent.name}`, 'success');
            }
            
            function showInteractionMenu(cell, student) {
                const rect = cell.getBoundingClientRect();
                const menu = DOMElements.interactionMenu;
                menu.dataset.studentId = student.id;
                document.getElementById('interaction-student-name').textContent = student.name;
                
                menu.style.left = `${rect.left}px`;
                menu.style.top = `${rect.bottom + 5}px`;

                if (rect.bottom + menu.offsetHeight > window.innerHeight) {
                    menu.style.top = `${rect.top - menu.offsetHeight - 5}px`;
                }
                if (rect.left + menu.offsetWidth > window.innerWidth) {
                    menu.style.left = `${rect.right - menu.offsetWidth}px`;
                }
                menu.classList.add('active');
            }

            function closeInteractionMenu() {
                DOMElements.interactionMenu.classList.remove('active');
            }

            function generateReport() {
                const activeClass = getActiveClass();
                const studentsInGrid = Object.values(activeClass.classroomLayout).filter(Boolean);
                const lowParticipationStudents = studentsInGrid.filter(student => {
                    const studentInteractions = activeClass.interactions[student.id];
                    return !studentInteractions || Object.values(studentInteractions).reduce((a, b) => a + b, 0) === 0;
                });
                
                const lowParticipationList = document.getElementById('low-participation-list');
                lowParticipationList.innerHTML = lowParticipationStudents.length === 0
                    ? `<div class="participation-item"><span>üéâ Todos os alunos na grelha participaram!</span></div>`
                    : lowParticipationStudents.map(s => `<div class="participation-item"><span>${s.name} (N¬∫ ${s.number})</span><span class="status status--warning">Sem participa√ß√£o</span></div>`).join('');

                const interactionDetailsContainer = document.getElementById('interaction-details-container');
                const interactionsByType = {};

                for (const [studentId, studentInteractions] of Object.entries(activeClass.interactions)) {
                    const student = activeClass.students.find(s => s.id === parseInt(studentId));
                    if (!student) continue;

                    for (const [type, count] of Object.entries(studentInteractions)) {
                        if (count > 0) {
                            if (!interactionsByType[type]) {
                                interactionsByType[type] = { total: 0, students: [] };
                            }
                            interactionsByType[type].total += count;
                            interactionsByType[type].students.push({ name: student.name, count });
                        }
                    }
                }

                const sortedInteractionTypes = Object.entries(interactionsByType).sort(([, a], [, b]) => b.total - a.total);

                if (sortedInteractionTypes.length === 0) {
                    interactionDetailsContainer.innerHTML = `<div class="participation-item"><span>Ainda n√£o foram registadas intera√ß√µes.</span></div>`;
                } else {
                    interactionDetailsContainer.innerHTML = sortedInteractionTypes.map(([type, data]) => {
                        const typeInfo = INTERACTION_TYPES[type];
                        data.students.sort((a, b) => b.count - a.count);
                        return `
                            <details class="report-details">
                                <summary class="report-summary">
                                    <span class="report-summary-label">
                                        <span class="interaction-icon">${typeInfo.icon}</span>
                                        <span>${typeInfo.label}</span>
                                    </span>
                                    <strong>${data.total}</strong>
                                </summary>
                                <ul class="report-student-list">
                                    ${data.students.map(s => `<li>${s.name} (${s.count}x)</li>`).join('')}
                                </ul>
                            </details>
                        `;
                    }).join('');
                }
            }

            function exportReportToCSV() {
                const activeClass = getActiveClass();
                let csvContent = "data:text/csv;charset=utf-8,";
                
                csvContent += `Relatorio da Turma;${activeClass.name}\r\n`;
                const now = new Date();
                csvContent += `Data;${now.toLocaleDateString('pt-PT')}\r\n`;
                csvContent += `Hora;${now.toLocaleTimeString('pt-PT')}\r\n\r\n`;

                csvContent += "Alunos Menos Participativos\r\n";
                csvContent += "Nome do Aluno;Numero\r\n";
                const studentsInGrid = Object.values(activeClass.classroomLayout).filter(Boolean);
                const lowParticipationStudents = studentsInGrid.filter(student => {
                    const studentInteractions = activeClass.interactions[student.id];
                    return !studentInteractions || Object.values(studentInteractions).reduce((a, b) => a + b, 0) === 0;
                });

                if (lowParticipationStudents.length === 0) {
                    csvContent += "Todos os alunos participaram.\r\n";
                } else {
                    lowParticipationStudents.forEach(student => {
                        csvContent += `"${student.name}";"${student.number}"\r\n`;
                    });
                }
                csvContent += "\r\n";

                csvContent += "Detalhe das Interacoes\r\n";
                csvContent += "Tipo de Interacao;Aluno;Contagem\r\n";

                Object.entries(INTERACTION_TYPES).forEach(([type, typeInfo]) => {
                    const studentsWithThisInteraction = [];
                    activeClass.students.forEach(student => {
                        const count = activeClass.interactions[student.id]?.[type] || 0;
                        if (count > 0) {
                            studentsWithThisInteraction.push({ name: student.name, count });
                        }
                    });

                    if (studentsWithThisInteraction.length > 0) {
                        studentsWithThisInteraction.sort((a, b) => b.count - a.count);
                        studentsWithThisInteraction.forEach(studentData => {
                            csvContent += `"${typeInfo.label}";"${studentData.name}";${studentData.count}\r\n`;
                        });
                    }
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `relatorio_${activeClass.name.replace(/\s+/g, '_')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast("Relat√≥rio exportado com sucesso!", "success");
            }
            
            function populateClassManagementModal() {
                DOMElements.classSelectDropdown.innerHTML = Object.values(appState.classes)
                    .map(c => `<option value="${c.id}" ${c.id === appState.activeClassId ? 'selected' : ''}>${c.name}</option>`)
                    .join('');
            }
            
            function handleCreateClass(e) {
                e.preventDefault();
                const input = document.getElementById('new-class-name');
                const newName = input.value.trim();
                if (newName) {
                    createNewClass(newName);
                    input.value = '';
                    populateClassManagementModal();
                    renderAll();
                }
            }

            function handleSelectClass(e) {
                appState.activeClassId = e.target.value;
                saveState();
                renderAll();
            }

            function handleRenameClass(e) {
                e.preventDefault();
                const input = document.getElementById('rename-class-name');
                const newName = input.value.trim();
                if (newName) {
                    getActiveClass().name = newName;
                    input.value = '';
                    saveState();
                    populateClassManagementModal();
                    updateHeader();
                    showToast("Turma renomeada com sucesso.", "success");
                }
            }

            function handleDeleteClass() {
                if (Object.keys(appState.classes).length <= 1) {
                    showToast("N√£o pode apagar a √∫nica turma existente.", "error");
                    return;
                }
                const className = getActiveClass().name;
                showConfirmation(`Tem a certeza que deseja apagar a turma "${className}"?`, () => {
                    delete appState.classes[appState.activeClassId];
                    appState.activeClassId = Object.keys(appState.classes)[0];
                    saveState();
                    populateClassManagementModal();
                    renderAll();
                    showToast(`Turma "${className}" apagada.`, "success");
                });
            }
        });
    </script>
</body>
</html>
